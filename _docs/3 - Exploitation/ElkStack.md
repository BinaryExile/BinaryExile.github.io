---
title: ELK Stack
category: Exploitation
order: 103
---

**Important Files:**

These files could contain credentials:

* Elasticsearch configuration: /etc/elasticsearch/elasticsearch.yml
* On elasticsearch system (user roles): /etc/elasticsearch/users_roles
* Kibana configuration: /etc/kibana/kibana.yml
* Logstash configuration: /etc/logstash/logstash.yml
* Filebeat configuration: /etc/filebeat/filebeat.yml

**Elasticsearch**

Test if authentication is enabled/disabled:

{% highlight bash %}
curl -X GET "ELASTICSEARCH-SERVER:9200/"
{
  "name" : "userver",
  "cluster_name" : "elasticsearch",
  "cluster_uuid" : "lZNH15okQPWfNHp-Aks0OQ",
  "version" : {
    "number" : "7.9.3",
    "build_flavor" : "default",
    "build_type" : "deb",
    "build_hash" : "c4138e51121ef06a6404866cddc601906fe5c868",
    "build_date" : "2020-10-16T10:36:16.141335Z",
    "build_snapshot" : false,
    "lucene_version" : "8.6.2",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}

curl -X GET "ELASTICSEARCH-SERVER:9200/_xpack/security/user"
//Disabled
{"error":{"root_cause":[{"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."}],"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."},"status":500}
//enabled
{"error":{"root_cause":[{"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}}],"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}},"status":401}
{% endhighlight %}

Default Accounts:

* elastic (This is the superuser! Older versions of Elasticsearch have the default password changeme for this user)
* kibana_system
* logstash_system
* beats_system
* apm_system
* remote_monitoring_user
* _anonymous (if version was returned but authentication is enabled)


Using the API key:

{% highlight bash %}
curl -H "Authorization: ApiKey <API-KEY>" ELASTICSEARCH-SERVER:9200/
{% endhighlight %}

Get more information about the rights of an user:

{% highlight bash %}
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user/<USERNAME>"
{% endhighlight %}

List all users on the system:

{% highlight bash %}
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user"
{% endhighlight %}

List all roles on the system:

{% highlight bash %}
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/role
{% endhighlight %}

**Kaibana**

Uses the same credentials as elasticsearch.

Post-Access Exfiltration:

* Try to access data from Elasticsearch
* Check if you can access the users panel and if you can edit, delete or create new users, roles or API Keys (Stack Management -> Users/Roles/API Keys)
* Check the current version for vulnerabilities (There was a RCE vulnerability in 2019 for Kibana versions < 6.6.0

**Logstash**


* Finding credentials in pipelines (/etc/logstash/pipelines.yml):

{% highlight bash %}
# This file is where you define your pipelines. You can define multiple.
# For more information on multiple pipelines, see the documentation:
# https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html

- pipeline.id: main
  path.config: "/etc/logstash/conf.d/*.conf"
- pipeline.id: example
  path.config: "/usr/share/logstash/pipeline/1*.conf"
  pipeline.workers: 6
{% endhighlight %}

The .conf files contain the configured pipelines which may contain credentials for an Elasticsearch instance.  Since logstash has to write data the priviledges are often higher.

* Check the priviledges of the logstach user and see if it is worth trying to privesc
* Check if you can restart the logstash service, or /etc/logstash/logstash.yml contains the entry <code>config.reload.automatic: true</code>
* If so, check for write permissions on a pipeline config or if /etc/logstash/pipelines.yml contains wildcards for a folder you can write in. Example of whoami command executed every 120 seconds with the output put to /tmp/output.log:

{% highlight bash %}
input {
  exec {
    command => "whoami"
    interval => 120
  }
}

output {
  file {
    path => "/tmp/output.log"
    codec => rubydebug
  }
}
{% endhighlight %}

**References**
* [insinuator](https://insinuator.net/2021/01/pentesting-the-elk-stack/)


